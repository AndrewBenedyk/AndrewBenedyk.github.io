<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictions Leaderboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 15px;
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
        }
        h1 {
            text-align: center;
            font-size: 1.5em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        th {
            font-weight: bold;
        }
        td:nth-child(1), td:nth-child(3) {
            text-align: center;
        }
        .loader {
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1 id="gp-name">üèÅ –ó–∞–≥–∞–ª—å–Ω–∏–π –∑–∞–ª—ñ–∫</h1>
    
    <div id="leaderboard-container">
        <div class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
        async function displayLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            
            try {
                // 1. –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –Ω–∞—à–æ–≥–æ –±–µ–∫–µ–Ω–¥—É
                const response = await fetch('/api/season_data');
                const seasonData = await response.json();

                // –ü—Ä–∏–º—ñ—Ç–∫–∞: –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–∏–∫–ª–∞–¥—É –º–∏ –±–µ—Ä–µ–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ-–ª—ñ–ø—à–æ–≥–æ —á–∞—Ç—É –∑ —Ñ–∞–π–ª—É.
                // –í –º–∞–π–±—É—Ç–Ω—å–æ–º—É –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫, —â–æ–± Web App —Ä–æ–∑—É–º—ñ–≤, –∑ —è–∫–æ–≥–æ —á–∞—Ç—É –π–æ–≥–æ –≤—ñ–¥–∫—Ä–∏–ª–∏.
                const firstChatId = Object.keys(seasonData)[0];
                if (!firstChatId) {
                    container.innerHTML = '<p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.</p>';
                    return;
                }
                const chatData = seasonData[firstChatId];
                const users = chatData.users;

                // 2. –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤ –º–∞—Å–∏–≤ —ñ —Å–æ—Ä—Ç—É—î–º–æ –∑–∞ –±–∞–ª–∞–º–∏
                const sortedUsers = Object.values(users).sort((a, b) => b.season_total - a.season_total);

                // 3. –°—Ç–≤–æ—Ä—é—î–º–æ HTML-—Ç–∞–±–ª–∏—Ü—é
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–£—á–∞—Å–Ω–∏–∫</th>
                                <th>–ë–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 4. –ù–∞–ø–æ–≤–Ω—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é –¥–∞–Ω–∏–º–∏
                sortedUsers.forEach((user, index) => {
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${user.name}</td>
                            <td><strong>${user.season_total}</strong></td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                // 5. –í—Å—Ç–∞–≤–ª—è—î–º–æ –≥–æ—Ç–æ–≤—É —Ç–∞–±–ª–∏—Ü—é –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É
                container.innerHTML = tableHTML;

            } catch (error) {
                container.innerHTML = '<p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.</p>';
                console.error('Error fetching or processing data:', error);
            }
        }

        // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        displayLeaderboard();

    </script>
</body>
</html>